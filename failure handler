// FAILURE HANDLER - Medi Desk Patient Assistant (Fixed)
response = Map();
// Log failure details for debugging and monitoring
info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
info "FAILURE HANDLER TRIGGERED";
info "Timestamp: " + zoho.currenttime;
info "Failed Response: " + failed_response.toString();
info "Cause: " + cause.toString();
info "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";
// Get visitor information for admin notification
visitorName = visitor.get("name");
visitorEmail = visitor.get("email");
visitorPhone = visitor.get("phone");
// Prepare detailed failure report for admin
failureReport = "MEDI DESK BOT FAILURE ALERT\n\n";
failureReport = failureReport + "Timestamp: " + zoho.currenttime + "\n\n";
failureReport = failureReport + "VISITOR DETAILS:\n";
failureReport = failureReport + "Name: " + visitorName + "\n";
failureReport = failureReport + "Email: " + visitorEmail + "\n";
failureReport = failureReport + "Phone: " + visitorPhone + "\n\n";
failureReport = failureReport + "FAILURE DETAILS:\n";
failureReport = failureReport + "Failed Action: " + failed_response.get("action") + "\n";
// Get error code if available
errorCode = 0;
if(cause.get("code") != null)
{
	errorCode = cause.get("code").toNumber();
	failureReport = failureReport + "Error Code: " + errorCode + "\n";
}
// Get error message if available
if(cause.get("message") != null)
{
	failureReport = failureReport + "Error Message: " + cause.get("message") + "\n";
}
failureReport = failureReport + "\nFull Failed Response: " + failed_response.toString();
failureReport = failureReport + "\nFull Cause: " + cause.toString();
// Send failure alert to admin
sendmail
[
	from :zoho.adminuserid
	to :"admin@medidesk.com"
	subject :"Medi Desk Bot Failure - Code " + errorCode
	message :failureReport
]
// Get the failed action type
failedAction = failed_response.get("action");
// ========== HANDLE FORWARD FAILURES (Agent Transfer Issues) ==========
if(failedAction != null && failedAction.equalsIgnoreCase("forward"))
{
	// 1001 - OUTSIDE BUSINESS HOURS
	if(errorCode == 1001)
	{
		response.put("action","reply");
		response.put("replies",{"â° We're Currently Outside Working Hours\n\nOUR WORKING HOURS:\nâ€¢ Monday - Saturday: 9:00 AM - 8:00 PM\nâ€¢ Sunday: 10:00 AM - 6:00 PM\n\nğŸš¨ FOR MEDICAL EMERGENCIES (24/7):\nğŸ“ Call 112 (National Emergency)\nğŸ¥ Hospital Emergency: +91-98765-43210\nğŸš‘ Ambulance Service: +91-98765-43211\n\nMeanwhile, I can help you with:\nâœ… Book appointments for tomorrow\nâœ… Schedule lab tests\nâœ… View health packages\nâœ… Leave a callback message\n\nWhat would you like to do?"});
		response.put("suggestions",{"Book Appointment","Lab Test Booking","Health Packages","Emergency Contact","Leave Message"});
	}
	// 1002 - ALL OPERATORS BUSY
	else if(errorCode == 1002)
	{
		response.put("action","reply");
		response.put("replies",{"ğŸ˜Š High Volume - All Agents Currently Busy\n\nAll our healthcare advisors are assisting other patients.\n\nâ±ï¸ ESTIMATED WAIT TIME: 5-10 minutes\n\nINSTANT SOLUTIONS (No Waiting!):\nâœ… Book Appointment - Get confirmed in 2 minutes\nâœ… Schedule Lab Tests - Book home collection now\nâœ… View Health Packages - Compare and book\nâœ… Request Callback - We'll call within 1 hour\n\nğŸ“ DIRECT CONTACT:\nâ€¢ Main Line: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: contact@medidesk.com\n\nWhat would you prefer?"});
		response.put("suggestions",{"Wait for Agent","Book Appointment","Lab Test Booking","Request Callback","Call Us"});
	}
	// 1003 - INVALID OR DISABLED OPERATORS
	else if(errorCode == 1003)
	{
		response.put("action","reply");
		response.put("replies",{"âš ï¸ Live Chat Temporarily Unavailable\n\nOur live chat support is experiencing technical difficulties.\n\nALTERNATIVE WAYS TO REACH US:\nğŸ“ Phone: +91-98765-43210\nğŸ“§ Email: contact@medidesk.com\nğŸ’¬ WhatsApp: +91-98765-43210\n\nI CAN STILL HELP YOU WITH:\nâœ… Book doctor appointments\nâœ… Schedule lab tests\nâœ… Browse health packages\nâœ… Get emergency contacts\n\nHow can I assist you?"});
		response.put("suggestions",{"Book Appointment","Lab Test Booking","Call Hospital","WhatsApp Us","Email Us"});
	}
	// GENERIC FORWARD FAILURE
	else
	{
		response.put("action","reply");
		response.put("replies",{"âŒ Unable to Connect to Support Agent\n\nWe're having trouble connecting you to our support team right now.\n\nğŸ“ IMMEDIATE CONTACT OPTIONS:\nâ€¢ Phone: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: contact@medidesk.com\n\nğŸš¨ For emergencies: Call 112\n\nMeanwhile, I can help you:\nâœ… Book appointments\nâœ… Schedule tests\nâœ… View packages\n\nWhat would you like to do?"});
		response.put("suggestions",{"Book Appointment","Lab Tests","Call Us","Emergency","Back to Menu"});
	}
}
// ========== HANDLE CONTEXT FAILURES (Form/Booking Issues) ==========
else if(failedAction != null && failedAction.equalsIgnoreCase("context"))
{
	response.put("action","reply");
	response.put("replies",{"ğŸ˜” Oops! Something Went Wrong\n\nWe encountered an issue while processing your request.\n\nPOSSIBLE REASONS:\nâ€¢ Network connectivity issue\nâ€¢ Invalid or incomplete information\nâ€¢ System timeout\nâ€¢ Temporary server glitch\n\nWHAT YOU CAN DO:\nâœ… Try booking again (most issues resolve on retry)\nâœ… Check your internet connection\nâœ… Contact our support team directly\nâœ… Call us for manual booking\n\nğŸ“ QUICK HELP:\nâ€¢ Phone: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: appointments@medidesk.com\n\nWould you like to try again?"});
	response.put("suggestions",{"Try Again","Call Support","Talk to Agent","Email Us","Back to Menu"});
}
// ========== HANDLE API/INTEGRATION FAILURES ==========
else if(cause.containsKey("message") && (cause.get("message").contains("API") || cause.get("message").contains("integration") || cause.get("message").contains("connection") || cause.get("message").contains("CRM")))
{
	response.put("action","reply");
	response.put("replies",{"âš ï¸ System Integration Issue\n\nWe're experiencing a temporary technical issue with our booking system.\n\nğŸ“ BOOK VIA PHONE (Instant!):\nâ€¢ Call: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\n\nğŸ“§ BOOK VIA EMAIL:\nâ€¢ Send details to: appointments@medidesk.com\nâ€¢ We'll confirm within 30 minutes\n\nâ±ï¸ OR TRY AGAIN:\nâ€¢ Wait 2-3 minutes and retry\nâ€¢ Clear browser cache and refresh\n\nğŸš¨ FOR EMERGENCIES:\nâ€¢ Call 112 immediately\nâ€¢ Hospital Emergency: +91-98765-43210\n\nWe apologize for the inconvenience!"});
	response.put("suggestions",{"Try Again in 2 Minutes","Call to Book","WhatsApp Booking","Email Booking","Emergency"});
}
// ========== HANDLE TIMEOUT FAILURES ==========
else if(cause.containsKey("timeout") || cause.containsKey("message") && cause.get("message").contains("timeout"))
{
	response.put("action","reply");
	response.put("replies",{"â±ï¸ Request Timeout\n\nYour request took too long to process.\n\nPOSSIBLE REASONS:\nâ€¢ Slow internet connection\nâ€¢ Server overload during peak hours\nâ€¢ Network interruption\n\nQUICK SOLUTIONS:\n1. Check your internet connection\n2. Refresh the page and try again\n3. Switch to mobile data (if on WiFi)\n4. Try from a different device\n\nğŸ“ OR BOOK DIRECTLY:\nâ€¢ Phone: +91-98765-43210 (Instant booking!)\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: appointments@medidesk.com\n\nğŸš¨ For emergencies: Call 112\n\nReady to try again?"});
	response.put("suggestions",{"Try Again","Call Us","WhatsApp Us","Emergency","Back to Menu"});
}
// ========== HANDLE EMAIL SENDING FAILURES ==========
else if(failedAction != null && (failedAction.equalsIgnoreCase("email") || cause.containsKey("message") && cause.get("message").contains("email")))
{
	response.put("action","reply");
	response.put("replies",{"ğŸ“§ Email Delivery Issue\n\nâœ… GOOD NEWS: Your booking was successful!\n\nâš ï¸ However, we couldn't send the confirmation email right now.\n\nDON'T WORRY - WE'VE GOT YOU COVERED:\nâœ… SMS confirmation sent to your mobile\nâœ… Your booking is saved in our system\nâœ… We'll resend the email within 1 hour\n\nPLEASE CHECK:\nâ€¢ Spam/Junk folder\nâ€¢ Verify email address is correct\nâ€¢ Add appointments@medidesk.com to contacts\n\nğŸ“ FOR CONFIRMATION:\nâ€¢ Call: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\n\nWe'll verify your booking details immediately!\n\nAnything else I can help with?"});
	response.put("suggestions",{"Resend Email","Call for Confirmation","WhatsApp Confirmation","Back to Menu"});
}
// ========== HANDLE DATABASE/STORAGE FAILURES ==========
else if(cause.containsKey("message") && (cause.get("message").contains("database") || cause.get("message").contains("storage") || cause.get("message").contains("record") || cause.get("message").contains("save")))
{
	response.put("action","reply");
	response.put("replies",{"âš ï¸ Data Storage Issue\n\nWe couldn't save your information due to a temporary technical issue.\n\nğŸ“ BOOK MANUALLY (Guaranteed!):\n\nCall us with your details:\nâ€¢ Phone: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\n\nOur team will book your appointment manually and confirm immediately.\n\nğŸ“§ OR EMAIL YOUR DETAILS:\nâ€¢ To: appointments@medidesk.com\nâ€¢ Include: Name, Phone, Preferred Date/Time, Specialty\nâ€¢ Confirmation within 30 minutes\n\nâ±ï¸ OR TRY AGAIN:\nâ€¢ Wait 5 minutes and retry booking\n\nWe apologize for the inconvenience!"});
	response.put("suggestions",{"Try Again","Call to Book","WhatsApp Booking","Email Details","Back to Menu"});
}
// ========== HANDLE REPLY FAILURES ==========
else if(failedAction != null && failedAction.equalsIgnoreCase("reply"))
{
	response.put("action","reply");
	response.put("replies",{"âŒ Message Delivery Failed\n\nWe're experiencing a technical issue.\n\nğŸ’™ I apologize for the inconvenience!\n\nğŸ“ REACH US DIRECTLY:\nâ€¢ Phone: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: contact@medidesk.com\n\nğŸš¨ Emergency: Call 112\n\nHow can I help you?"});
	response.put("suggestions",{"Try Again","Book Appointment","Call Us","Emergency","Back to Menu"});
}
// ========== HANDLE PAYMENT/TRANSACTION FAILURES ==========
else if(cause.containsKey("message") && (cause.get("message").contains("payment") || cause.get("message").contains("transaction") || cause.get("message").contains("billing")))
{
	response.put("action","reply");
	response.put("replies",{"ğŸ’³ Payment Processing Issue\n\nâš ï¸ We encountered an issue processing your payment.\n\nâœ… IMPORTANT: Your appointment is still CONFIRMED!\n\nPAYMENT OPTIONS:\n1. Pay at Hospital Reception\n   â€¢ Cash, Card, UPI accepted\n   â€¢ Before/after consultation\n\n2. Try Online Payment Again\n   â€¢ Different payment method\n   â€¢ Check card/bank details\n\n3. Contact Billing Department\n   â€¢ Phone: +91-98765-43210 (Ext: 101)\n   â€¢ Email: billing@medidesk.com\n\nğŸ”’ Your payment details are secure.\nğŸ’™ Your appointment stands confirmed!\n\nWhat would you like to do?"});
	response.put("suggestions",{"Retry Payment","Pay at Hospital","Contact Billing","View Appointment","Back to Menu"});
}
// ========== GENERIC FAILURE (Catch-All) ==========
else
{
	response.put("action","reply");
	response.put("replies",{"âŒ Unexpected Error Occurred\n\nWe encountered an unexpected technical issue.\n\nğŸ“ IMMEDIATE ASSISTANCE:\nâ€¢ Phone: +91-98765-43210\nâ€¢ WhatsApp: +91-98765-43210\nâ€¢ Email: contact@medidesk.com\n\nâ° Available: Mon-Sat, 9 AM - 8 PM\n\nYOU CAN:\nâœ… Try your action again\nâœ… Return to main menu\nâœ… Contact support directly\nâœ… Book via phone (instant!)\n\nğŸš¨ FOR MEDICAL EMERGENCIES:\nCall 112 immediately!\n\nWe sincerely apologize for the inconvenience.\n\nYour health matters to us! ğŸ’™"});
	response.put("suggestions",{"Try Again","Call Hospital","WhatsApp Us","Emergency: Call 112","Back to Menu"});
}
return response;
